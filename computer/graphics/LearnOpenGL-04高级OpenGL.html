<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LearnOpenGL-04高级OpenGL | NightWatch</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/favicon.png">
    <meta name="description" content="编程，从入门到入土">
    
    <link rel="preload" href="/assets/css/0.styles.4c261fea.css" as="style"><link rel="preload" href="/assets/js/app.e45fe4ea.js" as="script"><link rel="preload" href="/assets/js/2.4829a41e.js" as="script"><link rel="preload" href="/assets/js/1.21e39df5.js" as="script"><link rel="preload" href="/assets/js/88.9b6583e3.js" as="script"><link rel="prefetch" href="/assets/js/10.36ab4607.js"><link rel="prefetch" href="/assets/js/100.68473196.js"><link rel="prefetch" href="/assets/js/101.8183e396.js"><link rel="prefetch" href="/assets/js/102.ed322dcb.js"><link rel="prefetch" href="/assets/js/103.202f3683.js"><link rel="prefetch" href="/assets/js/104.4f71e1e0.js"><link rel="prefetch" href="/assets/js/105.872c1ad3.js"><link rel="prefetch" href="/assets/js/106.a62939ef.js"><link rel="prefetch" href="/assets/js/107.8df127ab.js"><link rel="prefetch" href="/assets/js/108.74509eab.js"><link rel="prefetch" href="/assets/js/109.e1a050a1.js"><link rel="prefetch" href="/assets/js/11.9d26e9af.js"><link rel="prefetch" href="/assets/js/110.306129c3.js"><link rel="prefetch" href="/assets/js/111.9d5f8e90.js"><link rel="prefetch" href="/assets/js/112.288d98e2.js"><link rel="prefetch" href="/assets/js/113.21b129bd.js"><link rel="prefetch" href="/assets/js/114.9c90e335.js"><link rel="prefetch" href="/assets/js/115.9f3663a2.js"><link rel="prefetch" href="/assets/js/116.4be36be2.js"><link rel="prefetch" href="/assets/js/117.8aedd8ce.js"><link rel="prefetch" href="/assets/js/118.72509372.js"><link rel="prefetch" href="/assets/js/119.37f500db.js"><link rel="prefetch" href="/assets/js/12.0b61f8e9.js"><link rel="prefetch" href="/assets/js/120.ebc326bc.js"><link rel="prefetch" href="/assets/js/121.44dc2eb4.js"><link rel="prefetch" href="/assets/js/122.48ec7a5a.js"><link rel="prefetch" href="/assets/js/123.2fe43538.js"><link rel="prefetch" href="/assets/js/124.80a647ca.js"><link rel="prefetch" href="/assets/js/125.f8aaecef.js"><link rel="prefetch" href="/assets/js/126.35ca4ff1.js"><link rel="prefetch" href="/assets/js/127.1f554834.js"><link rel="prefetch" href="/assets/js/128.5d0902ca.js"><link rel="prefetch" href="/assets/js/129.01988334.js"><link rel="prefetch" href="/assets/js/13.152b21ae.js"><link rel="prefetch" href="/assets/js/130.31a2d2ce.js"><link rel="prefetch" href="/assets/js/131.963112d5.js"><link rel="prefetch" href="/assets/js/132.556c3eac.js"><link rel="prefetch" href="/assets/js/133.931d774f.js"><link rel="prefetch" href="/assets/js/134.7bcd278d.js"><link rel="prefetch" href="/assets/js/135.044f8adf.js"><link rel="prefetch" href="/assets/js/136.fc6a9033.js"><link rel="prefetch" href="/assets/js/137.f54075f7.js"><link rel="prefetch" href="/assets/js/138.1e7452ca.js"><link rel="prefetch" href="/assets/js/139.f69184fd.js"><link rel="prefetch" href="/assets/js/14.601864c0.js"><link rel="prefetch" href="/assets/js/140.4d2f1723.js"><link rel="prefetch" href="/assets/js/141.56314d84.js"><link rel="prefetch" href="/assets/js/142.95ea6c1d.js"><link rel="prefetch" href="/assets/js/143.c051a1e7.js"><link rel="prefetch" href="/assets/js/144.bcdcb381.js"><link rel="prefetch" href="/assets/js/145.71ac8b51.js"><link rel="prefetch" href="/assets/js/146.8ee05072.js"><link rel="prefetch" href="/assets/js/147.536e77a6.js"><link rel="prefetch" href="/assets/js/148.d9fa97f5.js"><link rel="prefetch" href="/assets/js/149.cbe970ab.js"><link rel="prefetch" href="/assets/js/15.1ca2d588.js"><link rel="prefetch" href="/assets/js/150.fd3e0bbb.js"><link rel="prefetch" href="/assets/js/151.9e32dd02.js"><link rel="prefetch" href="/assets/js/152.f639441f.js"><link rel="prefetch" href="/assets/js/153.e38d0459.js"><link rel="prefetch" href="/assets/js/154.08185ea7.js"><link rel="prefetch" href="/assets/js/155.2e821938.js"><link rel="prefetch" href="/assets/js/156.fa772e27.js"><link rel="prefetch" href="/assets/js/157.0dca2d20.js"><link rel="prefetch" href="/assets/js/158.762db9d0.js"><link rel="prefetch" href="/assets/js/159.8f6339da.js"><link rel="prefetch" href="/assets/js/16.f4f9fc10.js"><link rel="prefetch" href="/assets/js/160.1f6f6b21.js"><link rel="prefetch" href="/assets/js/161.20812d5b.js"><link rel="prefetch" href="/assets/js/162.048804c9.js"><link rel="prefetch" href="/assets/js/163.21920f55.js"><link rel="prefetch" href="/assets/js/164.758838c9.js"><link rel="prefetch" href="/assets/js/165.460c4942.js"><link rel="prefetch" href="/assets/js/166.47b2a4be.js"><link rel="prefetch" href="/assets/js/167.7b3af263.js"><link rel="prefetch" href="/assets/js/168.dc84dec4.js"><link rel="prefetch" href="/assets/js/169.25445cf4.js"><link rel="prefetch" href="/assets/js/17.c0c7e874.js"><link rel="prefetch" href="/assets/js/170.3b41dfc9.js"><link rel="prefetch" href="/assets/js/171.d84a3809.js"><link rel="prefetch" href="/assets/js/172.0a927cd3.js"><link rel="prefetch" href="/assets/js/173.095fdbd2.js"><link rel="prefetch" href="/assets/js/174.43c086a6.js"><link rel="prefetch" href="/assets/js/175.30f9ee53.js"><link rel="prefetch" href="/assets/js/18.1dcc6d96.js"><link rel="prefetch" href="/assets/js/19.eb1d2ccc.js"><link rel="prefetch" href="/assets/js/20.e0b38ec4.js"><link rel="prefetch" href="/assets/js/21.78e23c64.js"><link rel="prefetch" href="/assets/js/22.2aa7a141.js"><link rel="prefetch" href="/assets/js/23.552ccc24.js"><link rel="prefetch" href="/assets/js/24.df43dd39.js"><link rel="prefetch" href="/assets/js/25.96ecf866.js"><link rel="prefetch" href="/assets/js/26.4f2285bc.js"><link rel="prefetch" href="/assets/js/27.eb9c1477.js"><link rel="prefetch" href="/assets/js/28.659a292d.js"><link rel="prefetch" href="/assets/js/29.8a0c6519.js"><link rel="prefetch" href="/assets/js/3.ce969d4f.js"><link rel="prefetch" href="/assets/js/30.61ad33e1.js"><link rel="prefetch" href="/assets/js/31.bb535084.js"><link rel="prefetch" href="/assets/js/32.0d73764d.js"><link rel="prefetch" href="/assets/js/33.d854944d.js"><link rel="prefetch" href="/assets/js/34.1a6fb4ca.js"><link rel="prefetch" href="/assets/js/35.a5786e05.js"><link rel="prefetch" href="/assets/js/36.4d26611c.js"><link rel="prefetch" href="/assets/js/37.a3e417ea.js"><link rel="prefetch" href="/assets/js/38.63934bec.js"><link rel="prefetch" href="/assets/js/39.a66ee55b.js"><link rel="prefetch" href="/assets/js/4.b8125ad6.js"><link rel="prefetch" href="/assets/js/40.4320ca5e.js"><link rel="prefetch" href="/assets/js/41.26c4d875.js"><link rel="prefetch" href="/assets/js/42.bb2b42d5.js"><link rel="prefetch" href="/assets/js/43.37393ad9.js"><link rel="prefetch" href="/assets/js/44.f80ecf82.js"><link rel="prefetch" href="/assets/js/45.f3e46d43.js"><link rel="prefetch" href="/assets/js/46.ab9dd200.js"><link rel="prefetch" href="/assets/js/47.d6eb2918.js"><link rel="prefetch" href="/assets/js/48.d38bb593.js"><link rel="prefetch" href="/assets/js/49.070d89fb.js"><link rel="prefetch" href="/assets/js/5.2d50631a.js"><link rel="prefetch" href="/assets/js/50.4e5265c1.js"><link rel="prefetch" href="/assets/js/51.ac2a13be.js"><link rel="prefetch" href="/assets/js/52.0a4800e7.js"><link rel="prefetch" href="/assets/js/53.e3e7d05a.js"><link rel="prefetch" href="/assets/js/54.3df7bd34.js"><link rel="prefetch" href="/assets/js/55.82bf2e61.js"><link rel="prefetch" href="/assets/js/56.6d31d02b.js"><link rel="prefetch" href="/assets/js/57.9aad0375.js"><link rel="prefetch" href="/assets/js/58.c138b114.js"><link rel="prefetch" href="/assets/js/59.897af365.js"><link rel="prefetch" href="/assets/js/6.674e2ad9.js"><link rel="prefetch" href="/assets/js/60.9707d8b9.js"><link rel="prefetch" href="/assets/js/61.4551eafb.js"><link rel="prefetch" href="/assets/js/62.fe4fbc4d.js"><link rel="prefetch" href="/assets/js/63.3daa6e86.js"><link rel="prefetch" href="/assets/js/64.87c9a821.js"><link rel="prefetch" href="/assets/js/65.68fec546.js"><link rel="prefetch" href="/assets/js/66.efcc969e.js"><link rel="prefetch" href="/assets/js/67.1d2e2204.js"><link rel="prefetch" href="/assets/js/68.55521584.js"><link rel="prefetch" href="/assets/js/69.72e40d21.js"><link rel="prefetch" href="/assets/js/7.f1dd9a86.js"><link rel="prefetch" href="/assets/js/70.366e32cd.js"><link rel="prefetch" href="/assets/js/71.0005d41c.js"><link rel="prefetch" href="/assets/js/72.60243c42.js"><link rel="prefetch" href="/assets/js/73.1e16472b.js"><link rel="prefetch" href="/assets/js/74.5f2062e8.js"><link rel="prefetch" href="/assets/js/75.f1272965.js"><link rel="prefetch" href="/assets/js/76.24218d28.js"><link rel="prefetch" href="/assets/js/77.f2c3889e.js"><link rel="prefetch" href="/assets/js/78.4b919712.js"><link rel="prefetch" href="/assets/js/79.7579439c.js"><link rel="prefetch" href="/assets/js/80.8ed7ce4f.js"><link rel="prefetch" href="/assets/js/81.676b3de5.js"><link rel="prefetch" href="/assets/js/82.4839f913.js"><link rel="prefetch" href="/assets/js/83.d3084d5a.js"><link rel="prefetch" href="/assets/js/84.22d34fb6.js"><link rel="prefetch" href="/assets/js/85.fbe159e4.js"><link rel="prefetch" href="/assets/js/86.09a45a14.js"><link rel="prefetch" href="/assets/js/87.eeb8e718.js"><link rel="prefetch" href="/assets/js/89.6e499301.js"><link rel="prefetch" href="/assets/js/90.9dead783.js"><link rel="prefetch" href="/assets/js/91.9ad56618.js"><link rel="prefetch" href="/assets/js/92.86f8c31d.js"><link rel="prefetch" href="/assets/js/93.63af9c58.js"><link rel="prefetch" href="/assets/js/94.261d726b.js"><link rel="prefetch" href="/assets/js/95.e620cb7e.js"><link rel="prefetch" href="/assets/js/96.03533def.js"><link rel="prefetch" href="/assets/js/97.c517219b.js"><link rel="prefetch" href="/assets/js/98.251517f9.js"><link rel="prefetch" href="/assets/js/99.b1c12770.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.271bc088.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4c261fea.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NightWatch</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端开发" class="dropdown-title"><span class="title">前端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端开发" class="mobile-dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-end/Basic/" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/front-end/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/front-end/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/front-end/前端工程化/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/性能优化/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/数据格式/" class="nav-link">
  数据格式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端开发" class="dropdown-title"><span class="title">后端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端开发" class="mobile-dropdown-title"><span class="title">后端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back-end/environment/" class="nav-link">
  环境配置
</a></li><li class="dropdown-item"><!----> <a href="/back-end/mysql/" class="nav-link">
  MySQL数据库
</a></li><li class="dropdown-item"><!----> <a href="/back-end/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/back-end/springboot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/back-end/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/back-end/docker/" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/computer/linux/" class="nav-link">
  Linux操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer/windows/" class="nav-link">
  Windows操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer/graphics/" class="nav-link router-link-active">
  计算机图形学
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="AI" class="dropdown-title"><span class="title">AI</span> <span class="arrow down"></span></button> <button type="button" aria-label="AI" class="mobile-dropdown-title"><span class="title">AI</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/large-model/" class="nav-link">
  大模型
</a></li><li class="dropdown-item"><!----> <a href="/ai/machine-learning/" class="nav-link">
  机器学习
</a></li><li class="dropdown-item"><!----> <a href="/ai/deep-learning/" class="nav-link">
  深度学习
</a></li><li class="dropdown-item"><!----> <a href="/ai/computer-vision/" class="nav-link">
  计算机视觉
</a></li><li class="dropdown-item"><!----> <a href="/ai/NLP/" class="nav-link">
  自然语言处理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIS开发" class="dropdown-title"><span class="title">GIS开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIS开发" class="mobile-dropdown-title"><span class="title">GIS开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gis/GIS原理/" class="nav-link">
  GIS原理
</a></li><li class="dropdown-item"><!----> <a href="/gis/WebGIS/" class="nav-link">
  WebGIS开发
</a></li><li class="dropdown-item"><!----> <a href="/gis/地图学/" class="nav-link">
  地图学
</a></li><li class="dropdown-item"><!----> <a href="/gis/数据库/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/gis/tools/" class="nav-link">
  GIS工具
</a></li></ul></div></div><div class="nav-item"><a href="/rong/" class="nav-link">
  Rong
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/test/1.html" class="nav-link">
  测试
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端开发" class="dropdown-title"><span class="title">前端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端开发" class="mobile-dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-end/Basic/" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/front-end/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/front-end/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/front-end/前端工程化/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/性能优化/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/数据格式/" class="nav-link">
  数据格式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端开发" class="dropdown-title"><span class="title">后端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端开发" class="mobile-dropdown-title"><span class="title">后端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back-end/environment/" class="nav-link">
  环境配置
</a></li><li class="dropdown-item"><!----> <a href="/back-end/mysql/" class="nav-link">
  MySQL数据库
</a></li><li class="dropdown-item"><!----> <a href="/back-end/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/back-end/springboot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/back-end/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/back-end/docker/" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/computer/linux/" class="nav-link">
  Linux操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer/windows/" class="nav-link">
  Windows操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer/graphics/" class="nav-link router-link-active">
  计算机图形学
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="AI" class="dropdown-title"><span class="title">AI</span> <span class="arrow down"></span></button> <button type="button" aria-label="AI" class="mobile-dropdown-title"><span class="title">AI</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/large-model/" class="nav-link">
  大模型
</a></li><li class="dropdown-item"><!----> <a href="/ai/machine-learning/" class="nav-link">
  机器学习
</a></li><li class="dropdown-item"><!----> <a href="/ai/deep-learning/" class="nav-link">
  深度学习
</a></li><li class="dropdown-item"><!----> <a href="/ai/computer-vision/" class="nav-link">
  计算机视觉
</a></li><li class="dropdown-item"><!----> <a href="/ai/NLP/" class="nav-link">
  自然语言处理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIS开发" class="dropdown-title"><span class="title">GIS开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIS开发" class="mobile-dropdown-title"><span class="title">GIS开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gis/GIS原理/" class="nav-link">
  GIS原理
</a></li><li class="dropdown-item"><!----> <a href="/gis/WebGIS/" class="nav-link">
  WebGIS开发
</a></li><li class="dropdown-item"><!----> <a href="/gis/地图学/" class="nav-link">
  地图学
</a></li><li class="dropdown-item"><!----> <a href="/gis/数据库/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/gis/tools/" class="nav-link">
  GIS工具
</a></li></ul></div></div><div class="nav-item"><a href="/rong/" class="nav-link">
  Rong
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/test/1.html" class="nav-link">
  测试
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Graphics</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computer/graphics/" aria-current="page" class="sidebar-link">♥计算机图形学♥</a></li><li><a href="/computer/graphics/LearnOpenGL-01入门.html" class="sidebar-link">LearnOpenGL-01入门</a></li><li><a href="/computer/graphics/LearnOpenGL-02光照.html" class="sidebar-link">LearnOpenGL-02光照</a></li><li><a href="/computer/graphics/LearnOpenGL-03模型加载.html" class="sidebar-link">LearnOpenGL-03模型加载</a></li><li><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html" class="active sidebar-link">LearnOpenGL-04高级OpenGL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#深度测试" class="sidebar-link">深度测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#深度缓冲" class="sidebar-link">深度缓冲</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#深度测试-2" class="sidebar-link">深度测试</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#深度测试函数" class="sidebar-link">深度测试函数</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#深度值精度" class="sidebar-link">深度值精度</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#深度冲突" class="sidebar-link">深度冲突</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#防止深度冲突" class="sidebar-link">防止深度冲突</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#模板测试" class="sidebar-link">模板测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#模板缓冲" class="sidebar-link">模板缓冲</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#模板测试-2" class="sidebar-link">模板测试</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#模板缓冲函数" class="sidebar-link">模板缓冲函数</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#物体轮廓" class="sidebar-link">物体轮廓</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#混合" class="sidebar-link">混合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#混合函数" class="sidebar-link">混合函数</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#渲染半透明纹理" class="sidebar-link">渲染半透明纹理</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#面剔除" class="sidebar-link">面剔除</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#环绕顺序" class="sidebar-link">环绕顺序</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#帧缓冲" class="sidebar-link">帧缓冲</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#创建帧缓冲" class="sidebar-link">创建帧缓冲</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#纹理附件" class="sidebar-link">纹理附件</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#渲染到纹理" class="sidebar-link">渲染到纹理</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#特殊后期效果" class="sidebar-link">特殊后期效果</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#核效果" class="sidebar-link">核效果</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#后视镜效果" class="sidebar-link">后视镜效果</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#立方体贴图" class="sidebar-link">立方体贴图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#优化" class="sidebar-link">优化</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#环境映射" class="sidebar-link">环境映射</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#高级数据" class="sidebar-link">高级数据</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#高级glsl" class="sidebar-link">高级GLSL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#顶点着色器变量" class="sidebar-link">顶点着色器变量</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#片段着色器变量" class="sidebar-link">片段着色器变量</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#接口块" class="sidebar-link">接口块</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#uniform缓冲对象" class="sidebar-link">Uniform缓冲对象</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#uniform块布局" class="sidebar-link">Uniform块布局</a></li></ul></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#几何着色器" class="sidebar-link">几何着色器</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#实例化" class="sidebar-link">实例化</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#抗锯齿" class="sidebar-link">抗锯齿</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#缓冲对象生命周期" class="sidebar-link">缓冲对象生命周期</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#常见的gl-xxx目标常量和-当前状态-的对应关系" class="sidebar-link">常见的GL_XXX目标常量和 “当前状态” 的对应关系</a></li><li class="sidebar-sub-header"><a href="/computer/graphics/LearnOpenGL-04高级OpenGL.html#反射、折射" class="sidebar-link">反射、折射</a></li></ul></li></ul></li><li><a href="/computer/graphics/LearnOpenGL-05高级光照.html" class="sidebar-link">LearnOpenGL-05高级光照</a></li><li><a href="/computer/graphics/LearnOpenGL-06PBR.html" class="sidebar-link">LearnOpenGL-06PBR</a></li><li><a href="/computer/graphics/LearnOpenGL-07实战.html" class="sidebar-link">LearnOpenGL-07实战</a></li><li><a href="/computer/graphics/LearnOpenGL-2020-骨骼动画.html" class="sidebar-link">LearnOpenGL-2020-骨骼动画</a></li><li><a href="/computer/graphics/LearnOpenGL-2021-CSM.html" class="sidebar-link">LearnOpenGL-2021-CSM</a></li><li><a href="/computer/graphics/LearnOpenGL-2022-区域光.html" class="sidebar-link">LearnOpenGL-2022-区域光</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="learnopengl-04高级opengl"><a href="#learnopengl-04高级opengl" class="header-anchor">#</a> LearnOpenGL-04高级OpenGL</h1> <h2 id="深度测试"><a href="#深度测试" class="header-anchor">#</a> 深度测试</h2> <h3 id="深度缓冲"><a href="#深度缓冲" class="header-anchor">#</a> 深度缓冲</h3> <blockquote><p><strong>为什么需要深度缓冲？</strong></p> <p>计算机屏幕是2D平面，但是我们要渲染3D场景。当多个像素在屏幕的同一坐标上重叠时，GPU需要判断，哪个像素离摄像机更近，应该显示出来；哪个更远，应该丢弃。</p></blockquote> <p>深度缓冲：防止被阻挡的面渲染到其它面的前面，也叫<strong>Z缓冲</strong></p> <blockquote><p>Z缓冲：是一块与屏幕分辨率大小相同的显存区域，每个像素位置豆村出一个深度值。</p> <p>数值范围：0.0-1.0,0.0表示离摄像头最近，1.0表示最远。</p> <p>深度值在光栅化阶段计算，通常用<strong>16 位、24 位或 32 位的浮点数</strong>存储。大部分系统是24位的。</p></blockquote> <h3 id="深度测试-2"><a href="#深度测试-2" class="header-anchor">#</a> 深度测试</h3> <p>被启用时，OpenGL会将一个片段的深度值与深度缓冲的内容进行对比，如果这个测试通过了的话，深度缓冲将会更新为新的深度值。如果深度测试失败了，片段将会被丢弃。</p> <p>启用深度测试：</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>清楚上次渲染迭代中写入的深度值：</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>不更新深度缓冲</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glDepthMask</span><span class="token punctuation">(</span>GL_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="深度测试函数"><a href="#深度测试函数" class="header-anchor">#</a> 深度测试函数</h3> <p>OpenGL允许我们修改深度测试中使用的比较运算符。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glDepthFunc</span><span class="token punctuation">(</span>GL_LESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><table><thead><tr><th>函数</th> <th>描述</th></tr></thead> <tbody><tr><td>GL_ALWAYS</td> <td>永远通过深度测试</td></tr> <tr><td>GL_NEVER</td> <td>永远不通过深度测试</td></tr> <tr><td>GL_LESS</td> <td>在片段深度值小于缓冲的深度值时通过测试</td></tr> <tr><td>GL_EQUAL</td> <td>在片段深度值等于缓冲区的深度值时通过测试</td></tr> <tr><td>GL_LEQUAL</td> <td>在片段深度值小于等于缓冲区的深度值时通过测试</td></tr> <tr><td>GL_GREATER</td> <td>在片段深度值大于缓冲区的深度值时通过测试</td></tr> <tr><td>GL_NOTEQUAL</td> <td>在片段深度值不等于缓冲区的深度值时通过测试</td></tr> <tr><td>GL_GEQUAL</td> <td>在片段深度值大于等于缓冲区的深度值时通过测试</td></tr></tbody></table> <h3 id="深度值精度"><a href="#深度值精度" class="header-anchor">#</a> 深度值精度</h3> <p>线性深度缓冲：</p> <blockquote><p>$$
\begin{equation} F_{depth} = \frac{z - near}{far - near} \end{equation}
$$</p> <p>z是观察空间中介于near和far之间的值，需要映射为[0,1]之间的范围。</p></blockquote> <p><strong>它做的就是在z值很小的时候提供非常高的精度，而在z值很远的时候提供更少的精度。</strong></p> <p>非线性深度缓冲:</p> <blockquote><p>$$
\begin{equation} F_{depth} = \frac{1/z - 1/near}{1/far - 1/near} \end{equation}
$$</p></blockquote> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/depth_non_linear_graph.png" alt="depth_non_linear_graph"></p> <h3 id="深度冲突"><a href="#深度冲突" class="header-anchor">#</a> 深度冲突</h3> <p>在两个平面或者三角形非常紧密地平行排列在一起时会发生，深度缓冲没有足够的精度来决定两个形状哪个在前面。结果就是这两个形状不断地在切换前后顺序，这会导致很奇怪的花纹。</p> <h3 id="防止深度冲突"><a href="#防止深度冲突" class="header-anchor">#</a> 防止深度冲突</h3> <p>深度冲突是深度缓冲的一个常见问题，当物体在远处时效果会更明显</p> <ul><li>永远不要把多个物体摆得太靠近，以至于它们的一些三角形会重叠。</li> <li>尽可能将近平面设置远一些</li> <li>使用更高精度的深度缓冲</li></ul> <h2 id="模板测试"><a href="#模板测试" class="header-anchor">#</a> 模板测试</h2> <h3 id="模板缓冲"><a href="#模板缓冲" class="header-anchor">#</a> 模板缓冲</h3> <p>每个模板值(Stencil Value)是8位的，每个像素有256中模板值，根据模板值来确定是否丢弃或保留片段。</p> <p>存储每个像素的整数标记值，是控制绘制区域的 “蒙版”，核心作用是标记像素、限制绘制范围。</p> <p>主要用来实现阴影、镜面、镂空、轮廓描边等特效。</p> <blockquote><p>模板缓冲是一块<strong>与屏幕分辨率大小相同的显存区域</strong>，每个像素位置存储一个<strong>整数值</strong>（通常是 8 位，取值 0~255）。它的作用就像一张 <strong>“模板蒙版”</strong>，可以为屏幕上的每个像素打上 “标记”，后续渲染时根据这个标记决定是否绘制该像素。</p></blockquote> <h3 id="模板测试-2"><a href="#模板测试-2" class="header-anchor">#</a> 模板测试</h3> <p>当片段着色器处理完一个片段后，模板测试可是执行，可能会丢弃片段，之后深度测试会执行。</p> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/stencil_buffer.png" alt="stencil_buffer"></p> <p>模板缓冲大体步骤：</p> <ul><li>启用模板缓冲的写入。</li> <li>渲染物体，更新模板缓冲的内容。</li> <li>禁用模板缓冲的写入。</li> <li>渲染（其它）物体，这次根据模板缓冲的内容丢弃特定的片段。</li></ul> <p>启用模板缓冲</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_STENCIL_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>每次迭代前清除模板缓冲</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT <span class="token operator">|</span> GL_STENCIL_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>控制模板缓冲的写入权限</strong></p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许写入模板缓冲（默认值</span>
<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁止写入模板缓冲（后续操作不会修改模板值）</span>
</code></pre></div><h3 id="模板缓冲函数"><a href="#模板缓冲函数" class="header-anchor">#</a> 模板缓冲函数</h3> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_EQUAL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>模板测试判断规则：</strong></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GLenum func<span class="token punctuation">,</span> GLint ref<span class="token punctuation">,</span> GLuint mask<span class="token punctuation">)</span>
</code></pre></div><ul><li><p><code>func</code>：设置模板测试函数(Stencil Test Function)。这个测试函数将会应用到已储存的模板值上和glStencilFunc函数的<code>ref</code>值上。可用的选项有：GL_NEVER、GL_LESS、GL_LEQUAL、GL_GREATER、GL_GEQUAL、GL_EQUAL、GL_NOTEQUAL和GL_ALWAYS。它们的语义和深度缓冲的函数类似。</p></li> <li><p><code>ref</code>：设置了模板测试的参考值(Reference Value)。模板缓冲的内容将会与这个值进行比较。</p></li> <li><p><code>mask</code>：设置一个掩码，它将会与参考值和储存的模板值在测试比较它们之前进行与(AND)运算。初始情况下所有位都为1。</p></li></ul> <p><strong>定义模板测试+深度测试后，模板缓冲值的修改规则：</strong></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glStencilOp</span><span class="token punctuation">(</span>GLenum sfail<span class="token punctuation">,</span> GLenum dpfail<span class="token punctuation">,</span> GLenum dppass<span class="token punctuation">)</span>
</code></pre></div><ul><li><code>sfail</code>：模板测试失败时采取的行为。</li> <li><code>dpfail</code>：模板测试通过，但深度测试失败时采取的行为。</li> <li><code>dppass</code>：模板测试和深度测试都通过时采取的行为。</li></ul> <p>每个选项都可以选用以下一种行为。</p> <table><thead><tr><th>行为</th> <th>描述</th></tr></thead> <tbody><tr><td>GL_KEEP</td> <td>保持当前储存的模板值</td></tr> <tr><td>GL_ZERO</td> <td>将模板值设置为0</td></tr> <tr><td>GL_REPLACE</td> <td>将模板值设置为glStencilFunc函数设置的<code>ref</code>值</td></tr> <tr><td>GL_INCR</td> <td>如果模板值小于最大值则将模板值加1</td></tr> <tr><td>GL_INCR_WRAP</td> <td>与GL_INCR一样，但如果模板值超过了最大值则归零</td></tr> <tr><td>GL_DECR</td> <td>如果模板值大于最小值则将模板值减1</td></tr> <tr><td>GL_DECR_WRAP</td> <td>与GL_DECR一样，但如果模板值小于0则将其设置为最大值</td></tr> <tr><td>GL_INVERT</td> <td>按位翻转当前的模板缓冲值</td></tr></tbody></table> <h3 id="物体轮廓"><a href="#物体轮廓" class="header-anchor">#</a> 物体轮廓</h3> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/stencil_object_outlining.png" alt="stencil_object_outlining"></p> <p>为物体创建轮廓的步骤：</p> <ol><li>启用模板写入。</li> <li>在绘制（需要添加轮廓的）物体之前，将模板函数设置为GL_ALWAYS，每当物体的片段被渲染时，将模板缓冲更新为1。</li> <li>渲染物体。</li> <li>禁用模板写入以及深度测试。</li> <li>将每个物体放大一点点。</li> <li>使用一个不同的片段着色器，输出一个单独的（边框）颜色。</li> <li>再次绘制物体，但只在它们片段的模板值不等于1时才绘制。</li> <li>再次启用模板写入和深度测试。</li></ol> <p>第一步，绘制模型</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_STENCIL_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_ALWAYS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 总是通过测试，参考值设为1</span>
<span class="token function">glStencilOp</span><span class="token punctuation">(</span>GL_KEEP<span class="token punctuation">,</span> GL_KEEP<span class="token punctuation">,</span> GL_REPLACE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 测试通过时，用1替换模板缓冲值</span>
<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许写入模板缓冲（0xFF表示全部位可写）</span>

<span class="token comment">// 绘制原始模型：此时模型覆盖的像素的模板缓冲值会被设为1，其他像素为0</span>
<span class="token function">DrawModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁止写入模板缓冲（后续操作不修改模板值）</span>
</code></pre></div><p>第二步，放大模型</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_NOTEQUAL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模板值不等于1时，测试通过</span>
<span class="token function">glStencilOp</span><span class="token punctuation">(</span>GL_KEEP<span class="token punctuation">,</span> GL_KEEP<span class="token punctuation">,</span> GL_KEEP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不修改模板缓冲值</span>

<span class="token comment">// 绘制放大后的模型（用黑色）：此时只有模板值为0的区域（模型外）会被绘制，形成轮廓</span>
<span class="token function">DrawScaledModel</span><span class="token punctuation">(</span><span class="token function">Color</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">glDisable</span><span class="token punctuation">(</span>GL_STENCIL_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁用模板测试</span>
</code></pre></div><h2 id="混合"><a href="#混合" class="header-anchor">#</a> 混合</h2> <p>在片段着色器中，如果一个片段的alpha值低于某个阈值，就丢弃片段</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture1<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>             
    <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture1<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>texColor<span class="token punctuation">.</span>a <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
        <span class="token keyword">discard</span><span class="token punctuation">;</span>
    FragColor <span class="token operator">=</span> texColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当需要渲染多个半透明图像时，就需要混合。</p> <p>$$
\begin{equation}\bar{C}<em>{result} = \bar{\color{green}C}</em>{source} * \color{green}F_{source} + \bar{\color{red}C}<em>{destination} * \color{red}F</em>{destination}\end{equation}
$$
混合颜色=源颜色向量<em>源因子值+目标颜色向量</em>目标因子值。</p> <p>让绿色正方形绘制在红色之上
$$
\begin{equation}\bar{C}_{result} = \begin{pmatrix} \color{red}{0.0} \ \color{green}{1.0} \ \color{blue}{0.0} \ \color{purple}{0.6} \end{pmatrix} * \color{green}{0.6} + \begin{pmatrix} \color{red}{1.0} \ \color{green}{0.0} \ \color{blue}{0.0} \ \color{purple}{1.0} \end{pmatrix} * (\color{red}{1 - 0.6}) \end{equation}
$$
<img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/blending_equation_mixed.png" alt="blending_equation_mixed"></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GLenum sfactor<span class="token punctuation">,</span> GLenum dfactor<span class="token punctuation">)</span>
</code></pre></div><p>可选项：GL_ZERO、GL_ONE、GL_SRC_COLOR、GL_ONE_MINUS_SRC_COLOR、GL_DST_COLOR等等</p> <h3 id="混合函数"><a href="#混合函数" class="header-anchor">#</a> 混合函数</h3> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>为RGB和Alpha设置不同的选项：</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glBlendFuncSeparate</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE<span class="token punctuation">,</span> GL_ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>设置Alpha通道运算符</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glBlendEquation</span><span class="token punctuation">(</span>GLenum mode<span class="token punctuation">)</span>
</code></pre></div><ul><li>GL_FUNC_ADD：默认选项，将两个分量相加</li> <li>GL_FUNC_SUBTRACT：将两个分量相减</li> <li>GL_FUNC_REVERSE_SUBTRACT：将两个分量相减，但顺序相反</li> <li>GL_MIN：取两个分量中的最小值</li> <li>GL_MAX：取两个分量中的最大值</li></ul> <h3 id="渲染半透明纹理"><a href="#渲染半透明纹理" class="header-anchor">#</a> 渲染半透明纹理</h3> <p>设定混合参数</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>不用丢弃片段了</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture1<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>             
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture1<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>深度测试和混合一起使用的话会产生一些麻烦。当写入深度缓冲时，深度缓冲不会检查片段是否是透明的，所以透明的部分会和其它值一样写入到深度缓冲中。</p> <p>要想让混合在多个物体上工作，我们需要最先绘制最远的物体，最后绘制最近的物体。</p> <p>当绘制一个有不透明和透明物体的场景的时候：</p> <ol><li>先绘制所有不透明的物体。</li> <li>对所有透明的物体排序。</li> <li>按顺序绘制所有透明的物体。</li></ol> <p>在场景中排序物体是一个很困难的技术，很大程度上由你场景的类型所决定，更别说它额外需要消耗的处理能力了。完整渲染一个包含不透明和透明物体的场景并不是那么容易。更高级的技术还有<strong>次序无关透明度</strong>。</p> <h2 id="面剔除"><a href="#面剔除" class="header-anchor">#</a> 面剔除</h2> <p>空间中观察一个立方体，最多能观察到几个面？3个。</p> <p>因此没有必要浪费时间绘制看不见的3个面。</p> <h3 id="环绕顺序"><a href="#环绕顺序" class="header-anchor">#</a> 环绕顺序</h3> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/faceculling_windingorder.png" alt="faceculling_windingorder"></p> <p>不同的环绕顺序</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">float</span> vertices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 顺时针</span>
    vertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点1</span>
    vertices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点2</span>
    vertices<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点3</span>
    <span class="token comment">// 逆时针</span>
    vertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点1</span>
    vertices<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点3</span>
    vertices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment">// 顶点2  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>OpenGL在渲染图元的时候将使用这个信息来决定一个三角形是一个正向三角形还是背向三角形。默认情况下，<strong>逆时针</strong>顶点所定义的三角形将会被处理为正向三角形。</p> <p>观察者所面向的所有三角形顶点就是我们所指定的正确环绕顺序了，而立方体另一面的三角形顶点则是以相反的环绕顺序所渲染的。这样的结果就是，我们所面向的三角形将会是正向三角形，而背面的三角形则是背向三角形。</p> <p>哇，太机智了！</p> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/faceculling_frontback.png" alt="faceculling_frontback"></p> <p>启用面剔除</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_CULL_FACE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要剔除的面的类型</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glCullFace</span><span class="token punctuation">(</span>GL_FRONT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>GL_BACK</code>：只剔除背向面。</li> <li><code>GL_FRONT</code>：只剔除正向面。</li> <li><code>GL_FRONT_AND_BACK</code>：剔除正向面和背向面。</li></ul> <p>将顺时针的面定义为正向面</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glFrontFace</span><span class="token punctuation">(</span>GL_CCW<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>注：正向还是背向是由三角形的顶点顺序决定的，和观察者角度无关！</p></blockquote> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/image-20251221143756538.png" alt="image-20251221143756538"></p> <h2 id="帧缓冲"><a href="#帧缓冲" class="header-anchor">#</a> 帧缓冲</h2> <p>用于写入颜色值的颜色缓冲、用于写入深度信息的深度缓冲和允许我们根据一些条件丢弃特定片段的模板缓冲，这些缓冲结合起来，叫帧缓冲(Framebuffer)。</p> <p>默认帧缓冲是在创建窗口时生成和配置的。通过创建自己的帧缓冲，可以获得额外的渲染目标。</p> <h3 id="创建帧缓冲"><a href="#创建帧缓冲" class="header-anchor">#</a> 创建帧缓冲</h3> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fbo<span class="token punctuation">;</span>
<span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>绑定为激活的帧缓冲</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> fbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>一个完整的帧缓冲需要满足以下的条件：</p> <ul><li>附加至少一个缓冲（颜色、深度或模板缓冲）。</li> <li>至少有一个颜色附件(Attachment)。</li> <li>所有的附件都必须是完整的（保留了内存）。</li> <li>每个缓冲都应该有相同的样本数(sample)。</li></ul> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">glCheckFramebufferStatus</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">)</span> <span class="token operator">==</span> GL_FRAMEBUFFER_COMPLETE<span class="token punctuation">)</span>
  <span class="token comment">// 执行胜利的舞蹈</span>
</code></pre></div><p>之后所有的渲染操作将会渲染到当前绑定帧缓冲的附件中。</p> <p>由于我们的帧缓冲不是默认帧缓冲，渲染指令将不会对窗口的视觉输出有任何影响。出于这个原因，渲染到一个不同的帧缓冲被叫做离屏渲染。</p> <p>要保证所有的渲染操作在主窗口中有视觉效果，我们需要再次激活默认帧缓冲，将它绑定到0.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 激活默认帧缓冲,0代表默认帧缓冲ID</span>
<span class="token function">glDeleteFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fbo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 删除帧缓冲对象，删除1个</span>
</code></pre></div><h3 id="纹理附件"><a href="#纹理附件" class="header-anchor">#</a> 纹理附件</h3> <p>附件是一个内存位置，它能够作为帧缓冲的一个缓冲，可以将它想象为一个图像，可以选择纹理或渲染缓冲对象。</p> <p>创建纹理</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> texture<span class="token punctuation">;</span>
<span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>附加到帧缓冲上</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>target</code>：帧缓冲的目标（绘制、读取或者两者皆有）</li> <li><code>attachment</code>：我们想要附加的附件类型。当前我们正在附加一个颜色附件。注意最后的<code>0</code>意味着我们可以附加多个颜色附件。我们将在之后的教程中提到。深度缓冲GL_DEPTH_ATTACHMENT，模板缓冲GL_STENCIL_ATTACHMENT</li> <li><code>textarget</code>：你希望附加的纹理类型</li> <li><code>texture</code>：要附加的纹理本身</li> <li><code>level</code>：多级渐远纹理的级别。我们将它保留为0。</li></ul> <h3 id="渲染到纹理"><a href="#渲染到纹理" class="header-anchor">#</a> 渲染到纹理</h3> <p>创建帧缓冲对象</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> framebuffer<span class="token punctuation">;</span>
<span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 生成1个帧缓冲对象</span>
<span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 绑定到GL_FRAMEBUFFER</span>
</code></pre></div><p>创建一个纹理图像，我们将它作为一个颜色附件附加到帧缓冲上</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// 生成纹理</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> texColorBuffer<span class="token punctuation">;</span>
<span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>texColorBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 生成一个纹理</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> texColorBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 绑定到当前使用的2D纹理目标</span>
<span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 为当前绑定的 2D 纹理分配显存并设置纹理的基本属性（尺寸、格式、数据）</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 纹理采样参数</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将当前使用的2D纹理目标，绑定到默认值0</span>

<span class="token comment">// 将它附加到当前绑定的帧缓冲对象</span>
<span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> texColorBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><p>创建渲染缓冲对象</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> rbo<span class="token punctuation">;</span>
<span class="token function">glGenRenderbuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindRenderbuffer</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> rbo<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glRenderbufferStorage</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> GL_DEPTH24_STENCIL8<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">glBindRenderbuffer</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将渲染缓冲对象附加到帧缓冲的深度<strong>和</strong>模板附件上</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glFramebufferRenderbuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_DEPTH_STENCIL_ATTACHMENT<span class="token punctuation">,</span> GL_RENDERBUFFER<span class="token punctuation">,</span> rbo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 解绑</span>
</code></pre></div><p>所以，要想绘制场景到一个纹理上，我们需要采取以下的步骤：</p> <ol><li>将新的帧缓冲绑定为激活的帧缓冲，和往常一样渲染场景</li> <li>绑定默认的帧缓冲</li> <li>绘制一个横跨整个屏幕的四边形，将帧缓冲的颜色缓冲作为它的纹理。</li></ol> <h3 id="特殊后期效果"><a href="#特殊后期效果" class="header-anchor">#</a> 特殊后期效果</h3> <p>反相</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token function">texture</span><span class="token punctuation">(</span>screenTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>灰度化</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>screenTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> average <span class="token operator">=</span> <span class="token punctuation">(</span>FragColor<span class="token punctuation">.</span>r <span class="token operator">+</span> FragColor<span class="token punctuation">.</span>g <span class="token operator">+</span> FragColor<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3.0</span><span class="token punctuation">;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>average<span class="token punctuation">,</span> average<span class="token punctuation">,</span> average<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>加权灰度</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>screenTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> average <span class="token operator">=</span> <span class="token number">0.2126</span> <span class="token operator">*</span> FragColor<span class="token punctuation">.</span>r <span class="token operator">+</span> <span class="token number">0.7152</span> <span class="token operator">*</span> FragColor<span class="token punctuation">.</span>g <span class="token operator">+</span> <span class="token number">0.0722</span> <span class="token operator">*</span> FragColor<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>average<span class="token punctuation">,</span> average<span class="token punctuation">,</span> average<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="核效果"><a href="#核效果" class="header-anchor">#</a> 核效果</h3> <p>核效果就是从纹理的其他地方采样颜色值</p> <p>锐化核：玩家打了麻醉剂的效果
$$
\begin{bmatrix}2 &amp; 2 &amp; 2 \ 2 &amp; -15 &amp; 2 \ 2 &amp; 2 &amp; 2 \end{bmatrix}
$$</p> <p>模糊核：模拟玩家醉酒状态，或者没戴眼镜状态
$$
\begin{bmatrix} 1 &amp; 2 &amp; 1 \ 2 &amp; 4 &amp; 2 \ 1 &amp; 2 &amp; 1 \end{bmatrix} / 16
$$</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> screenTexture<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">float</span> offset <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">300.0</span><span class="token punctuation">;</span>  
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//vec3 col = texture(screenTexture, TexCoords).rgb;</span>
    <span class="token comment">//FragColor = vec4(col, 1.0);</span>
    <span class="token keyword">vec2</span> offsets<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offset<span class="token punctuation">,</span>  offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 左上</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>    offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 正上</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span> offset<span class="token punctuation">,</span>  offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 右上</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offset<span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 左</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>    <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 中</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span> offset<span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 右</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offset<span class="token punctuation">,</span> <span class="token operator">-</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 左下</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>   <span class="token operator">-</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 正下</span>
        <span class="token keyword">vec2</span><span class="token punctuation">(</span> offset<span class="token punctuation">,</span> <span class="token operator">-</span>offset<span class="token punctuation">)</span>  <span class="token comment">// 右下</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
        <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span>  
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> sampleTex<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        sampleTex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>screenTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">.</span>st <span class="token operator">+</span> offsets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">vec3</span> col <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        col <span class="token operator">+=</span> sampleTex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> kernel<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>边缘检测：突出边缘
$$
\begin{bmatrix} 1 &amp; 1 &amp; 1 \ 1 &amp; -8 &amp; 1 \ 1 &amp; 1 &amp; 1 \end{bmatrix}
$$</p> <h3 id="后视镜效果"><a href="#后视镜效果" class="header-anchor">#</a> 后视镜效果</h3> <p>后视镜位置</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>    <span class="token keyword">float</span> quadVertices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// vertex attributes for a quad that fills the entire screen in Normalized Device Coordinates. NOTE that this plane is now much smaller and at the top of the screen</span>
        <span class="token comment">// positions   // texCoords</span>
        <span class="token operator">-</span><span class="token number">0.3f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.3f</span><span class="token punctuation">,</span>  <span class="token number">0.4f</span><span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>
         <span class="token number">0.3f</span><span class="token punctuation">,</span>  <span class="token number">0.4f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>

        <span class="token operator">-</span><span class="token number">0.3f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span>
         <span class="token number">0.3f</span><span class="token punctuation">,</span>  <span class="token number">0.4f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>
         <span class="token number">0.3f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>后视镜视野视图矩阵</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>shader<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
glm<span class="token double-colon punctuation">::</span>mat4 model <span class="token operator">=</span> glm<span class="token double-colon punctuation">::</span><span class="token function">mat4</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>Yaw   <span class="token operator">+=</span> <span class="token number">180.0f</span><span class="token punctuation">;</span> <span class="token comment">// rotate the camera's yaw 180 degrees around</span>
camera<span class="token punctuation">.</span><span class="token function">ProcessMouseMovement</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
glm<span class="token double-colon punctuation">::</span>mat4 view <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">GetViewMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>Yaw   <span class="token operator">-=</span> <span class="token number">180.0f</span><span class="token punctuation">;</span> <span class="token comment">// reset it back to its original orientation</span>
camera<span class="token punctuation">.</span><span class="token function">ProcessMouseMovement</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
glm<span class="token double-colon punctuation">::</span>mat4 projection <span class="token operator">=</span> glm<span class="token double-colon punctuation">::</span><span class="token function">perspective</span><span class="token punctuation">(</span>glm<span class="token double-colon punctuation">::</span><span class="token function">radians</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>Zoom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>SCR_WIDTH <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>SCR_HEIGHT<span class="token punctuation">,</span> <span class="token number">0.1f</span><span class="token punctuation">,</span> <span class="token number">100.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">&quot;projection&quot;</span><span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="立方体贴图"><a href="#立方体贴图" class="header-anchor">#</a> 立方体贴图</h2> <p>立方体贴图有6个面，每个面都需需要一个纹理。</p> <table><thead><tr><th>纹理目标</th> <th>方位</th></tr></thead> <tbody><tr><td><code>GL_TEXTURE_CUBE_MAP_POSITIVE_X</code></td> <td>右</td></tr> <tr><td><code>GL_TEXTURE_CUBE_MAP_NEGATIVE_X</code></td> <td>左</td></tr> <tr><td><code>GL_TEXTURE_CUBE_MAP_POSITIVE_Y</code></td> <td>上</td></tr> <tr><td><code>GL_TEXTURE_CUBE_MAP_NEGATIVE_Y</code></td> <td>下</td></tr> <tr><td><code>GL_TEXTURE_CUBE_MAP_POSITIVE_Z</code></td> <td>后</td></tr> <tr><td><code>GL_TEXTURE_CUBE_MAP_NEGATIVE_Z</code></td> <td>前</td></tr></tbody></table> <p>纹理目标背后的int值是线性增加的，可以从GL_TEXTURE_CUBE_MAP_POSITIVE_X开始遍历他们。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> nrChannels<span class="token punctuation">;</span>  <span class="token comment">//  纹理图片宽高，颜色通道数</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>   <span class="token comment">// 加载后的图片像素数据</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> textures_faces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token function">stbi_load</span><span class="token punctuation">(</span>textures_faces<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>width<span class="token punctuation">,</span> <span class="token operator">&amp;</span>height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nrChannels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>  <span class="token comment">// 将加载后的数据赋值给立方体贴图的第i个面</span>
        GL_TEXTURE_CUBE_MAP_POSITIVE_X <span class="token operator">+</span> i<span class="token punctuation">,</span> 
        <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> data
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>片段着色器中，采样器也是使用不同类型的</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">in</span> <span class="token keyword">vec3</span> textureDir<span class="token punctuation">;</span> <span class="token comment">// 代表3D纹理坐标的方向向量</span>
<span class="token keyword">uniform</span> <span class="token keyword">samplerCube</span> cubemap<span class="token punctuation">;</span> <span class="token comment">// 立方体贴图的纹理采样器</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>             
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>cubemap<span class="token punctuation">,</span> textureDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/cubemaps_skybox.png" alt="cubemaps_skybox"></p> <h3 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h3> <p>目前我们是首先渲染天空盒，之后再渲染场景中的其它物体。这样子能够工作，但不是非常高效。</p> <p>在提前深度测试通过的地方渲染天空盒的片段就可以了，很大程度上减少了片段着色器的调用。</p> <p>将输出位置的z分量等于w分量，z分量永远等于1，经过透视除法之后，z 会变为w/w=1</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    TexCoords <span class="token operator">=</span> aPos<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> pos <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> pos<span class="token punctuation">.</span>xyww<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>gl_Position 是顶点着色器的内置输出变量，它存储了顶点经过模型-视图-投影矩阵变换后的<strong>齐次裁剪空间坐标</strong>。</p> <p>OpenGL 会自动将裁剪空间坐标转换为屏幕空间坐标，这个过程叫做<strong>透视除法</strong>。</p> <p>同时，需要将深度测试的函数设置为<code>GL_LEQUAL</code>（小于等于），而不是默认的<code>GL_LESS</code>（小于）。这样才能正常渲染天空盒。</p> <h3 id="环境映射"><a href="#环境映射" class="header-anchor">#</a> 环境映射</h3> <p><strong>反射效果</strong></p> <p>顶点着色器</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aNormal<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec3</span> Normal<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec3</span> Position<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> model<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 将顶点的局部空间法向量转换为世界空间的法向量</span>
    Normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token function">inverse</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> aNormal<span class="token punctuation">;</span>
    <span class="token comment">// 将顶点的局部空间位置转换为世界空间位置</span>
    Position <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将顶点的局部空间位置转换为裁剪空间坐标</span>
    gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>片源着色器</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec3</span> Normal<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">vec3</span> Position<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> cameraPos<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">samplerCube</span> skybox<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>             
    <span class="token keyword">vec3</span> I <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Position <span class="token operator">-</span> cameraPos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 摄像机方向向量</span>
    <span class="token keyword">vec3</span> R <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 计算反射方向向量</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>skybox<span class="token punctuation">,</span> R<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//  从天空盒纹理采样,参数是立方体贴图和采样方向</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当反射应用到一整个物体上（像是箱子）时，这个物体看起来就像是钢或者铬这样的高反射性材质。现实中大部分的模型都不具有完全反射性。我们可以引入<code>反射贴图</code>。</p> <p><strong>折射效果</strong></p> <p>折射可以使用GLSL内建的<code>refract</code>函数实现，它需要一个法向量、一个观察方向和两个材质之间的折射率</p> <table><thead><tr><th>材质</th> <th>折射率</th></tr></thead> <tbody><tr><td>空气</td> <td>1.00</td></tr> <tr><td>水</td> <td>1.33</td></tr> <tr><td>冰</td> <td>1.309</td></tr> <tr><td>玻璃</td> <td>1.52</td></tr> <tr><td>钻石</td> <td>2.42</td></tr></tbody></table> <p>修改片源着色器</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>    
    <span class="token comment">//vec3 I = normalize(Position - cameraPos);</span>
    <span class="token comment">//vec3 R = reflect(I, normalize(Normal));</span>
    <span class="token comment">//FragColor = vec4(texture(skybox, R).rgb, 1.0);</span>
    <span class="token keyword">float</span> ratio <span class="token operator">=</span> <span class="token number">1.00</span> <span class="token operator">/</span> <span class="token number">1.52</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> I <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Position <span class="token operator">-</span> cameraPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> R <span class="token operator">=</span> <span class="token function">refract</span><span class="token punctuation">(</span>I<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Normal<span class="token punctuation">)</span><span class="token punctuation">,</span> ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自带折射函数</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>skybox<span class="token punctuation">,</span> R<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="高级数据"><a href="#高级数据" class="header-anchor">#</a> 高级数据</h2> <p>glBufferSubData填充缓冲的特定区域</p> <p>顶点数据可以分批传入缓存</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">float</span> positions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> normals<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> tex<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 填充缓冲</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>positions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normals<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tex<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将缓冲的内容复制到另一个缓冲中</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">glCopyBufferSubData</span><span class="token punctuation">(</span>GLenum readtarget<span class="token punctuation">,</span> GLenum writetarget<span class="token punctuation">,</span> GLintptr readoffset<span class="token punctuation">,</span>
                         GLintptr writeoffset<span class="token punctuation">,</span> GLsizeiptr size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="高级glsl"><a href="#高级glsl" class="header-anchor">#</a> 高级GLSL</h2> <p>GLSL的内建变量： gl_position gl_FragCoord</p> <h3 id="顶点着色器变量"><a href="#顶点着色器变量" class="header-anchor">#</a> 顶点着色器变量</h3> <p>gl_PointSize:设置渲染出来的点的大小</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_PROGRAM_POINT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>gl_VertexID:储存了正在绘制顶点的当前ID</p> <blockquote><p>当（使用glDrawElements）进行索引渲染的时候，这个变量会存储正在绘制顶点的当前索引。当（使用glDrawArrays）不使用索引进行绘制的时候，这个变量会储存从渲染调用开始的已处理顶点数量。</p></blockquote> <h3 id="片段着色器变量"><a href="#片段着色器变量" class="header-anchor">#</a> 片段着色器变量</h3> <p>gl_FragCoord：当前正在处理的片元在屏幕上的坐标和深度</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>         
    <span class="token comment">// 当像素x坐标小于400时，绘制不同的颜色</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span>
        FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
<span class="token punctuation">}</span>
</code></pre></div><p>gl_FrontFacing：告诉我们当前片段是属于正向面的一部分还是背向面的一部分</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> frontTexture<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> backTexture<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>             
    <span class="token comment">// 内部和外部使用不同的纹理</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>gl_FrontFacing<span class="token punctuation">)</span>
        FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>frontTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>backTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>gl_FragDepth：在着色器中设置片段的深度值</p> <blockquote><p>自己设置深度值，OpenGL会禁用所有的提前深度测试。因为OpenGL无法在片段着色器运行之前得知片段将拥有的深度值。</p> <p>从OpenGL4.2开始，在片段着色器顶部使用深度条件重新声明<code>gl_FragDepth</code>变量</p></blockquote> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">layout</span> <span class="token punctuation">(</span>depth_<span class="token operator">&lt;</span>condition<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">float</span> gl_FragDepth<span class="token punctuation">;</span>
</code></pre></div><p>condition取值</p> <table><thead><tr><th>条件</th> <th>描述</th></tr></thead> <tbody><tr><td><code>any</code></td> <td>默认值。提前深度测试是禁用的，你会损失很多性能</td></tr> <tr><td><code>greater</code></td> <td>你只能让深度值比<code>gl_FragCoord.z</code>更大</td></tr> <tr><td><code>less</code></td> <td>你只能让深度值比<code>gl_FragCoord.z</code>更小</td></tr> <tr><td><code>unchanged</code></td> <td>如果你要写入<code>gl_FragDepth</code>，你将只能写入<code>gl_FragCoord.z</code>的值</td></tr></tbody></table> <h3 id="接口块"><a href="#接口块" class="header-anchor">#</a> 接口块</h3> <p>管理封装着色器的输入输出，使用关键字<code>in</code>、<code>out</code></p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aTexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> model<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>

<span class="token comment">// 块名</span>
<span class="token keyword">out</span> VS_OUT
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>
<span class="token punctuation">}</span> vs_out<span class="token punctuation">;</span>  <span class="token comment">// 实例名</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    vs_out<span class="token punctuation">.</span>TexCoords <span class="token operator">=</span> aTexCoords<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>在片段着色器中： 块名一样，实例名可以不同</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> VS_OUT
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>
<span class="token punctuation">}</span> fs_in<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>             
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> fs_in<span class="token punctuation">.</span>TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre></div><h3 id="uniform缓冲对象"><a href="#uniform缓冲对象" class="header-anchor">#</a> Uniform缓冲对象</h3> <p>UBO(Uniform Buffer Object)</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>std140<span class="token punctuation">)</span> <span class="token keyword">uniform</span> Matrices
<span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> model<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Uniform块中的变量可以直接访问，不需要加块名作为前缀。</p> <h3 id="uniform块布局"><a href="#uniform块布局" class="header-anchor">#</a> Uniform块布局</h3> <p>std140布局声明了每个变量的偏移量都是由一系列规则所决定的，这<strong>显式地</strong>声明了每个变量类型的内存布局。一个变量的对齐字节偏移量<strong>必须</strong>等于基准对齐量的倍数。</p> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/advanced_glsl_binding_points.png" alt="advanced_glsl_binding_points"></p> <p>多个shader可以绑定到同一个绑定点，每个绑定点又绑定某个UBO，这样shader里的uniform块就和外部的UBO数据对应上了。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// 绑定块</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> lights_index <span class="token operator">=</span> <span class="token function">glGetUniformBlockIndex</span><span class="token punctuation">(</span>shaderA<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">&quot;Lights&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token function">glUniformBlockBinding</span><span class="token punctuation">(</span>shaderA<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> lights_index<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 绑定缓冲对象</span>
<span class="token function">glBindBufferBase</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> uboExampleBlock<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 或</span>
<span class="token function">glBindBufferRange</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> uboExampleBlock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>OpenGL4.2开始</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">layout</span><span class="token punctuation">(</span>std140<span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> Lights <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></blockquote> <h2 id="几何着色器"><a href="#几何着色器" class="header-anchor">#</a> 几何着色器</h2> <p>几何着色器在顶点和片段着色器之间，几何着色器的输入是一个图元(点或三角形)的一组顶点。几何着色器可以在顶点发送到下一着色器阶段之前对它们随意变换。能够将（这一组）顶点变换为完全不同的图元，并且还能生成比原来更多的顶点。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>line_strip<span class="token punctuation">,</span> max_vertices <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">out</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">EndPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用EmitVertex，gl_Position会被添加到图元中。EndPrimitive被调用，所有发射的顶点都会合成指定的输出渲染图元。</p> <p>Layout  输入布局修饰符可以接受以下任何一个图元值：</p> <ul><li><code>points</code>：绘制GL_POINTS图元时（1）。</li> <li><code>lines</code>：绘制GL_LINES或GL_LINE_STRIP时（2）</li> <li><code>lines_adjacency</code>：GL_LINES_ADJACENCY或GL_LINE_STRIP_ADJACENCY（4）</li> <li><code>triangles</code>：GL_TRIANGLES、GL_TRIANGLE_STRIP或GL_TRIANGLE_FAN（3）</li> <li><code>triangles_adjacency</code>：GL_TRIANGLES_ADJACENCY或GL_TRIANGLE_STRIP_ADJACENCY（6）</li></ul> <p>输出布局修饰符：</p> <ul><li><code>points</code></li> <li><code>line_strip</code></li> <li><code>triangle_strip</code></li></ul> <p><strong>几何着色器的输入是一个图元的所有顶点，用索引获取顶点。</strong></p> <p>OpenGL内建变量gl_in，内部看起来：</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">in</span> gl_Vertex
<span class="token punctuation">{</span>
    <span class="token keyword">vec4</span>  gl_Position<span class="token punctuation">;</span>
    <span class="token keyword">float</span> gl_PointSize<span class="token punctuation">;</span>
    <span class="token keyword">float</span> gl_ClipDistance<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> gl_in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="实例化"><a href="#实例化" class="header-anchor">#</a> 实例化</h2> <p>实例化：将数据一次性发送给GPU，使用一个绘制函数让OpenGL利用这些数据绘制多个物体，节省CPU到GPU的通信。</p> <p>最后一个参数是需要绘制的实例数量</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glDrawArraysInstanced</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>内建变量<code>gl_InstanceID</code>：从0开始，每个实例被渲染时递增1</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aColor<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec3</span> fColor<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> offsets<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> offset <span class="token operator">=</span> offsets<span class="token punctuation">[</span>gl_InstanceID<span class="token punctuation">]</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fColor <span class="token operator">=</span> aColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用顶点属性是，顶点着色器的每次运行都会让GLSL获取新一组适用于当前顶点的属性。</p> <p>当将顶点属性定义为一个实例化数组时。顶点着色器只需要对每个实例更新顶点内容。</p> <blockquote><p>所有实例共享一套顶点数据。</p></blockquote> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token function">glVertexAttribDivisor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>它的第一个参数是需要的顶点属性，第二个参数是属性除数(Attribute Divisor)。</p> <ul><li>默认情况下，属性除数是0，告诉OpenGL我们需要在顶点着色器的每次迭代时更新顶点属性。</li> <li>将它设置为1时，我们告诉OpenGL我们希望在渲染一个新实例的时候更新顶点属性。</li> <li>而设置为2时，我们希望每2个实例更新一次属性，以此类推。</li></ul> <h2 id="抗锯齿"><a href="#抗锯齿" class="header-anchor">#</a> 抗锯齿</h2> <p>多重采样抗锯齿(Multisample Anti-aliasing, MSAA)</p> <p>光栅器是位于最终处理过的顶点之后到片段着色器之前所有经过的算法与过程的总和。</p> <p>多重采样中不再使用像素中心的单一采样点，而采用以特定图形排列的4个子采样点。</p> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/anti_aliasing_sample_points.png" alt="anti_aliasing_sample_points"></p> <blockquote><p>工作方式：无论三角形遮盖了多少个采样点，每个像素只运行一次片段着色器，片段着色器使用插值到像素中心的顶点数据。被覆盖的子采样点数量决定了像素颜色对帧缓冲的影响程度。例如上图4个采样点有2个被遮盖了，所以三角形的颜色有一半与帧缓冲的颜色进行混合，形成一种淡蓝色。</p> <p>三角形的不平滑边缘被稍浅的颜色所包围后，从远处观察时就会显得更加平滑了。</p></blockquote> <p>4个采样点</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_SAMPLES<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <h3 id="缓冲对象生命周期"><a href="#缓冲对象生命周期" class="header-anchor">#</a> 缓冲对象生命周期</h3> <p>OpenGL的缓冲对象遵循生命周期：生成-绑定-使用-销毁</p> <h3 id="常见的gl-xxx目标常量和-当前状态-的对应关系"><a href="#常见的gl-xxx目标常量和-当前状态-的对应关系" class="header-anchor">#</a> 常见的<code>GL_XXX</code>目标常量和 “当前状态” 的对应关系</h3> <table><thead><tr><th>常量标识符</th> <th>对应的目标类型</th> <th>OpenGL 维护的 “当前状态”</th></tr></thead> <tbody><tr><td><code>GL_FRAMEBUFFER</code></td> <td>帧缓冲</td> <td>当前绑定的帧缓冲对象 ID（默认是 0）</td></tr> <tr><td><code>GL_ARRAY_BUFFER</code></td> <td>顶点数组缓冲</td> <td>当前绑定的顶点缓冲对象（VBO）ID</td></tr> <tr><td><code>GL_TEXTURE_2D</code></td> <td>2D 纹理</td> <td>当前绑定的 2D 纹理对象 ID</td></tr> <tr><td><code>GL_RENDERBUFFER</code></td> <td>渲染缓冲</td> <td>当前绑定的渲染缓冲对象（RBO）ID</td></tr></tbody></table> <ol><li><code>GL_FRAMEBUFFER</code>不是变量，是 OpenGL 的<strong>枚举常量</strong>，用于<strong>指定操作的目标类型</strong>（这里是帧缓冲）。</li> <li>OpenGL 作为状态机，会为每个<code>GL_XXX</code>目标类型维护 <strong>“当前绑定的对象 ID”</strong>。</li> <li>后续对该类型的所有操作，都会作用于这个 “当前绑定的对象”，直到你再次调用绑定函数切换对象。</li></ol> <h3 id="反射、折射"><a href="#反射、折射" class="header-anchor">#</a> 反射、折射</h3> <p>Opengl 计算反射、折射本质上需要纹理贴图和方向向量两个东西， 反射和折射计算方向向量各有一个函数，便于在纹理上采样。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/24/2025, 4:07:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/computer/graphics/LearnOpenGL-03模型加载.html" class="prev">
        LearnOpenGL-03模型加载
      </a></span> <span class="next"><a href="/computer/graphics/LearnOpenGL-05高级光照.html">
        LearnOpenGL-05高级光照
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e45fe4ea.js" defer></script><script src="/assets/js/2.4829a41e.js" defer></script><script src="/assets/js/1.21e39df5.js" defer></script><script src="/assets/js/88.9b6583e3.js" defer></script>
  </body>
</html>
