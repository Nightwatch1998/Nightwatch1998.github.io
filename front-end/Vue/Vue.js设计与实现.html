<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>框架设计概览 | NightWatch</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/images/favicon.png">
    <meta name="description" content="编程，从入门到入土">
    
    <link rel="preload" href="/assets/css/0.styles.34aacdd0.css" as="style"><link rel="preload" href="/assets/js/app.a000d84e.js" as="script"><link rel="preload" href="/assets/js/2.994b757b.js" as="script"><link rel="preload" href="/assets/js/50.d3186f56.js" as="script"><link rel="prefetch" href="/assets/js/10.b0dc23ab.js"><link rel="prefetch" href="/assets/js/11.a54da59e.js"><link rel="prefetch" href="/assets/js/12.ad25fb77.js"><link rel="prefetch" href="/assets/js/13.4106a679.js"><link rel="prefetch" href="/assets/js/14.83569b2f.js"><link rel="prefetch" href="/assets/js/15.d9426698.js"><link rel="prefetch" href="/assets/js/16.0ea418d9.js"><link rel="prefetch" href="/assets/js/17.93130a54.js"><link rel="prefetch" href="/assets/js/18.793eab1a.js"><link rel="prefetch" href="/assets/js/19.8ce14e6a.js"><link rel="prefetch" href="/assets/js/20.f5c4c435.js"><link rel="prefetch" href="/assets/js/21.448e3faa.js"><link rel="prefetch" href="/assets/js/22.c770b4a9.js"><link rel="prefetch" href="/assets/js/23.4bf911cc.js"><link rel="prefetch" href="/assets/js/24.415d2520.js"><link rel="prefetch" href="/assets/js/25.460a3daf.js"><link rel="prefetch" href="/assets/js/26.da97e4f0.js"><link rel="prefetch" href="/assets/js/27.a310b475.js"><link rel="prefetch" href="/assets/js/28.80ab6835.js"><link rel="prefetch" href="/assets/js/29.c50def65.js"><link rel="prefetch" href="/assets/js/3.a27eeac5.js"><link rel="prefetch" href="/assets/js/30.14e8903d.js"><link rel="prefetch" href="/assets/js/31.51574d37.js"><link rel="prefetch" href="/assets/js/32.66bdf70f.js"><link rel="prefetch" href="/assets/js/33.8fa7e647.js"><link rel="prefetch" href="/assets/js/34.768dbfc4.js"><link rel="prefetch" href="/assets/js/35.32884803.js"><link rel="prefetch" href="/assets/js/36.1388fb52.js"><link rel="prefetch" href="/assets/js/37.a32b014d.js"><link rel="prefetch" href="/assets/js/38.e8dc87b2.js"><link rel="prefetch" href="/assets/js/39.7f08ca37.js"><link rel="prefetch" href="/assets/js/4.c69c5b0e.js"><link rel="prefetch" href="/assets/js/40.ca274a04.js"><link rel="prefetch" href="/assets/js/41.402a010e.js"><link rel="prefetch" href="/assets/js/42.9c1c2334.js"><link rel="prefetch" href="/assets/js/43.b2817e3e.js"><link rel="prefetch" href="/assets/js/44.307d7fde.js"><link rel="prefetch" href="/assets/js/45.c6d62232.js"><link rel="prefetch" href="/assets/js/46.5d71db88.js"><link rel="prefetch" href="/assets/js/47.542c53eb.js"><link rel="prefetch" href="/assets/js/48.0fb64249.js"><link rel="prefetch" href="/assets/js/49.efd1c25c.js"><link rel="prefetch" href="/assets/js/5.4dc8d661.js"><link rel="prefetch" href="/assets/js/51.60267d48.js"><link rel="prefetch" href="/assets/js/52.ccb0bddf.js"><link rel="prefetch" href="/assets/js/53.410e3f01.js"><link rel="prefetch" href="/assets/js/54.3587f4da.js"><link rel="prefetch" href="/assets/js/55.7c089a3e.js"><link rel="prefetch" href="/assets/js/56.8736e8c2.js"><link rel="prefetch" href="/assets/js/57.f47fed7f.js"><link rel="prefetch" href="/assets/js/58.05b60435.js"><link rel="prefetch" href="/assets/js/59.d3f4068a.js"><link rel="prefetch" href="/assets/js/6.88d03338.js"><link rel="prefetch" href="/assets/js/60.e79ae06c.js"><link rel="prefetch" href="/assets/js/61.6bebffcb.js"><link rel="prefetch" href="/assets/js/62.eaabd0c5.js"><link rel="prefetch" href="/assets/js/63.6b01109d.js"><link rel="prefetch" href="/assets/js/64.8bc8a004.js"><link rel="prefetch" href="/assets/js/65.5debde19.js"><link rel="prefetch" href="/assets/js/66.0a7ee190.js"><link rel="prefetch" href="/assets/js/67.e36c5fd0.js"><link rel="prefetch" href="/assets/js/68.cf874854.js"><link rel="prefetch" href="/assets/js/69.741f747f.js"><link rel="prefetch" href="/assets/js/7.9de3ff65.js"><link rel="prefetch" href="/assets/js/70.b5fb68dc.js"><link rel="prefetch" href="/assets/js/71.44dfe957.js"><link rel="prefetch" href="/assets/js/72.c9738176.js"><link rel="prefetch" href="/assets/js/73.60a01f9d.js"><link rel="prefetch" href="/assets/js/74.90a7d33a.js"><link rel="prefetch" href="/assets/js/75.86ac9c8b.js"><link rel="prefetch" href="/assets/js/76.30429cb2.js"><link rel="prefetch" href="/assets/js/77.75e5bae5.js"><link rel="prefetch" href="/assets/js/78.f248fbc1.js"><link rel="prefetch" href="/assets/js/79.b5b8da4b.js"><link rel="prefetch" href="/assets/js/8.8c1df6e1.js"><link rel="prefetch" href="/assets/js/80.170fded5.js"><link rel="prefetch" href="/assets/js/81.9208212c.js"><link rel="prefetch" href="/assets/js/82.e0d71f45.js"><link rel="prefetch" href="/assets/js/83.5491bdf5.js"><link rel="prefetch" href="/assets/js/84.8019f1cc.js"><link rel="prefetch" href="/assets/js/85.c6ad84c7.js"><link rel="prefetch" href="/assets/js/86.f3dadf6b.js"><link rel="prefetch" href="/assets/js/87.2cd10c68.js"><link rel="prefetch" href="/assets/js/88.2bf001fa.js"><link rel="prefetch" href="/assets/js/89.bd11b633.js"><link rel="prefetch" href="/assets/js/9.6db7ff72.js"><link rel="prefetch" href="/assets/js/90.a16b9014.js"><link rel="prefetch" href="/assets/js/91.cf0ffa60.js"><link rel="prefetch" href="/assets/js/92.00c1e602.js"><link rel="prefetch" href="/assets/js/93.dc145e73.js"><link rel="prefetch" href="/assets/js/94.b46033f1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34aacdd0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NightWatch</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端开发" class="dropdown-title"><span class="title">前端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端开发" class="mobile-dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-end/Basic/" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/front-end/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/front-end/Vue/" class="nav-link router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/front-end/前端工程化/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/性能优化/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/数据格式/" class="nav-link">
  数据格式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端开发" class="dropdown-title"><span class="title">后端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端开发" class="mobile-dropdown-title"><span class="title">后端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back-end/environment/" class="nav-link">
  环境配置
</a></li><li class="dropdown-item"><!----> <a href="/back-end/mysql/" class="nav-link">
  MySQL数据库
</a></li><li class="dropdown-item"><!----> <a href="/back-end/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/back-end/springboot/" class="nav-link">
  SpringBoot
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIS开发" class="dropdown-title"><span class="title">GIS开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIS开发" class="mobile-dropdown-title"><span class="title">GIS开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gis/GIS原理/" class="nav-link">
  GIS原理
</a></li><li class="dropdown-item"><!----> <a href="/gis/WebGIS/" class="nav-link">
  WebGIS开发
</a></li><li class="dropdown-item"><!----> <a href="/gis/地图学/" class="nav-link">
  地图学
</a></li><li class="dropdown-item"><!----> <a href="/gis/数据库/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/gis/tools/" class="nav-link">
  GIS工具
</a></li></ul></div></div><div class="nav-item"><a href="/rong/" class="nav-link">
  Rong
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/test/1.html" class="nav-link">
  测试
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端开发" class="dropdown-title"><span class="title">前端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端开发" class="mobile-dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-end/Basic/" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/front-end/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/front-end/Vue/" class="nav-link router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/front-end/前端工程化/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/性能优化/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/数据格式/" class="nav-link">
  数据格式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端开发" class="dropdown-title"><span class="title">后端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端开发" class="mobile-dropdown-title"><span class="title">后端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back-end/environment/" class="nav-link">
  环境配置
</a></li><li class="dropdown-item"><!----> <a href="/back-end/mysql/" class="nav-link">
  MySQL数据库
</a></li><li class="dropdown-item"><!----> <a href="/back-end/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/back-end/springboot/" class="nav-link">
  SpringBoot
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIS开发" class="dropdown-title"><span class="title">GIS开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIS开发" class="mobile-dropdown-title"><span class="title">GIS开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gis/GIS原理/" class="nav-link">
  GIS原理
</a></li><li class="dropdown-item"><!----> <a href="/gis/WebGIS/" class="nav-link">
  WebGIS开发
</a></li><li class="dropdown-item"><!----> <a href="/gis/地图学/" class="nav-link">
  地图学
</a></li><li class="dropdown-item"><!----> <a href="/gis/数据库/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/gis/tools/" class="nav-link">
  GIS工具
</a></li></ul></div></div><div class="nav-item"><a href="/rong/" class="nav-link">
  Rong
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/test/1.html" class="nav-link">
  测试
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end/Vue/" aria-current="page" class="sidebar-link">♥Vue技术体系♥</a></li><li><a href="/front-end/Vue/Vue.js设计与实现.html" class="active sidebar-link">框架设计概览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#框架设计概览" class="sidebar-link">框架设计概览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#权衡的艺术" class="sidebar-link">权衡的艺术</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#框架设计的额核心要素" class="sidebar-link">框架设计的额核心要素</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#vue3的设计思路" class="sidebar-link">vue3的设计思路</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#响应系统" class="sidebar-link">响应系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#响应式系统的作用与实现" class="sidebar-link">响应式系统的作用与实现</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#非原始值的响应式方案" class="sidebar-link">非原始值的响应式方案</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#原始值的响应式方案" class="sidebar-link">原始值的响应式方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#渲染器renderer" class="sidebar-link">渲染器renderer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#渲染器的设计" class="sidebar-link">渲染器的设计</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#挂载与更新" class="sidebar-link">挂载与更新</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#简单diff算法-从头到尾" class="sidebar-link">简单diff算法(从头到尾)</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#双端diff算法-从头尾到中间" class="sidebar-link">双端diff算法(从头尾到中间)</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#快速diff算法" class="sidebar-link">快速diff算法</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#组件化" class="sidebar-link">组件化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#组件的实现原理" class="sidebar-link">组件的实现原理</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#异步组件与函数式组件" class="sidebar-link">异步组件与函数式组件</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#内建组件和模块" class="sidebar-link">内建组件和模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#编译器" class="sidebar-link">编译器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#编译器核心技术概览-3步" class="sidebar-link">编译器核心技术概览(3步)</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#解析器" class="sidebar-link">解析器</a></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#编译优化" class="sidebar-link">编译优化</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#服务端渲染" class="sidebar-link">服务端渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/Vue/Vue.js设计与实现.html#同构渲染" class="sidebar-link">同构渲染</a></li></ul></li></ul></li><li><a href="/front-end/Vue/Vue面试.html" class="sidebar-link">什么是MVVM、MVC？</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="框架设计概览"><a href="#框架设计概览" class="header-anchor">#</a> 框架设计概览</h2> <h3 id="权衡的艺术"><a href="#权衡的艺术" class="header-anchor">#</a> 权衡的艺术</h3> <ul><li><p>命令式和声明式：</p> <p>命令式关注过程，声明式关注结果。Vue的内部实现是命令式，暴露给用户是声明式。</p></li> <li><p>性能和可维护性：</p> <p>性能上命令式更优，声明式多了查找变更的性能消耗。但是声明式可维护性高。</p></li> <li><p>虚拟DOM的性能：<strong>增量更新</strong></p> <p>虚拟DOM为了最小化<strong>找出差异的性能消耗</strong>。</p> <p>与innerHTML对比：</p> <ul><li>创建页面差距不大</li> <li><strong>更新页面</strong>时差异较大，innerHTML需要销毁旧DOM元素，全量创建新的DOM元素。</li></ul></li> <li><p>运行时和编译时：</p> <ul><li>纯运行时：灵活性高，性能和安全性低</li> <li><strong>运行时+编译时</strong>：保留灵活性，尽可能优化性能</li> <li>纯编译时：性能高，但灵活性较低</li></ul></li></ul> <h3 id="框架设计的额核心要素"><a href="#框架设计的额核心要素" class="header-anchor">#</a> 框架设计的额核心要素</h3> <ul><li>提升用户的开发体验：控制台信息</li> <li>控制框架代码的体积：__DEV__区分开发环境</li> <li>做到良好的Tree-Shaking</li></ul> <div class="language- extra-class"><pre class="language-text"><code>/*#__PURE__*/  //告诉rollup.js没有副作用，可以放心删除
</code></pre></div><ul><li>框架的构建产物：IIFE、ESM</li> <li>特性开关：使用rollup.js的预定义常量插件实现</li> <li>错误处理：统一错误处理接口</li></ul> <h3 id="vue3的设计思路"><a href="#vue3的设计思路" class="header-anchor">#</a> vue3的设计思路</h3> <ul><li><strong>虚拟DOM</strong>就是用JS对象来描述DOM，<strong>渲染函数</strong>返回的结果就是虚拟DOM</li> <li><strong>渲染器</strong>的作用是将虚拟DOM渲染成真实DOM</li> <li>组件的本质：组件就是一组虚拟DOM元素的封装，可以是<strong>函数或者JS对象</strong></li> <li><strong>编译器</strong>：作用是将template模板编译为渲染函数，并添加在script标签块的组件对象上</li></ul> <h2 id="响应系统"><a href="#响应系统" class="header-anchor">#</a> 响应系统</h2> <h3 id="响应式系统的作用与实现"><a href="#响应式系统的作用与实现" class="header-anchor">#</a> 响应式系统的作用与实现</h3> <ol><li><p>副作用函数effect，执行会直接或间接影响其他函数的执行。√</p></li> <li><p>通过拦截字段的读取和设置操作，读取时，将effect放置在桶中，设置时，拿出effect并执行。需要将一个effrct函数绑定在一个某个对象的某个属性上。√</p></li> <li><p>数据结构使用了<strong>weakMap</strong>、Map和Set。weakMap的键为对象，值为对一个map，存储该对象所有属性的依赖；Map中的key为对象的属性，值为key相关的响应函数集合set。把副作用函数收集到桶里的逻辑封装为track，把触发副作用函数执行的逻辑封装到trigger中。变量<strong>activeEffect</strong>至关重要√</p></li> <li><p>分支切换带来的effect函数遗留问题：为effect添加<strong>依赖集合deps</strong>，每次执行时先把所有的相关依赖删除，这部分逻辑封装在<strong>cleanup</strong>里面，trigger中用一个新的set防止一直循环√</p></li> <li><p>嵌套的effect和<strong>effect栈</strong>，避免相互影响√</p></li> <li><p>避免无限递归循环，在同一个effect中读取和设置时会触发，<strong>trigger前添加守卫</strong>。√</p></li> <li><p><strong>调度执行</strong>，让用户控制trigger的<strong>执行方式、执行次数</strong>、<strong>执行时机</strong>√</p></li> <li><p>计算属性computed和lazy,添加值<strong>缓存</strong>、懒执行的副作用函数√</p></li> <li><p>watch的实现原理，<strong>基于调度器实现</strong>，<strong>递归地watch对象的所有属性</strong>，<strong>获取旧值和新值</strong>√</p></li> <li><p>立即执行的watch和回调执行时机，<strong>immediate</strong>指定回调是否立即执行，<strong>flush</strong>指定同步和异步执行√</p></li> <li><p>副作用过期，<strong>OnInvalidate</strong>注册过期回调，通过闭包exppired实现的</p></li></ol> <h3 id="非原始值的响应式方案"><a href="#非原始值的响应式方案" class="header-anchor">#</a> 非原始值的响应式方案</h3> <h4 id="基本原理"><a href="#基本原理" class="header-anchor">#</a> 基本原理</h4> <ol><li>Proxy能够拦截对象的基本操作，例如读取、复制、函数调用。</li> <li>Reflect.get()，可以绕过对象的getter函数获取属性值。<strong>不改变语言原本行为的情况下进行扩展和定制</strong>，是一种元编程</li></ol> <div class="language- extra-class"><pre class="language-text"><code>Reflect.get(target, propertyKey [, receiver])
</code></pre></div><p>target为对象，propertyKey为属性名，receiver表示 getter 函数的执行上下文对象</p> <ol start="3"><li><p>常规对象和异质对象。函数对象会部署[[call]]内部方法，普通对象则不会。</p> <p>常规对象：内部方法用<strong>ECMA规范</strong>10.1给出的定义实现、[[call]]通过10.2.1实现、[[construct]]10.2.2实现；其他的都是异质对象，如Proxy</p></li></ol> <h4 id="代理对象"><a href="#代理对象" class="header-anchor">#</a> 代理对象</h4> <p>要重点处理for...in的读取、添加、更新、删除操作。</p> <p><strong>读取操作</strong>：不同的读取，根据ECMA规范中使用的基本方法区分</p> <ul><li>访问属性:obj.foo，<strong>用拦截get</strong></li> <li>判断是否存在指定key：key in obj，<strong>has拦截函数</strong></li> <li>for...in循环，<strong>ownkeys拦截</strong></li></ul> <p><strong>设置/添加操作：</strong></p> <ul><li>set拦截函数，区分添加和更新</li></ul> <p><strong>删除操作：</strong></p> <ul><li>delete p.foo</li></ul> <p><strong>合理的触发响应：</strong></p> <ul><li>值是否真的发生了变化</li> <li>屏蔽原型带来的更新</li></ul> <p>**深响应与浅响应：**是否递归地把所有子属性也设置为可响应</p> <p>**只读与浅只读：**递归实现，拦截设置和删除操作</p> <h4 id="代理数组-异质对象"><a href="#代理数组-异质对象" class="header-anchor">#</a> 代理数组(异质对象)</h4> <p><strong>读取操作</strong>：</p> <ul><li>通过索引访问：arr[0]</li> <li>访问数组长度: arr.length</li> <li>for...in</li> <li>for...of</li> <li>原型方法，concat/join/every/some/find/findIndex/includes</li></ul> <p><strong>设置操作</strong>：</p> <ul><li>索引修改:arr[0]=0</li> <li>修改长度:arr.length = 0</li> <li>栈方法</li> <li>原型方法:split/fill/sort</li></ul> <ol><li><p>数组的索引与length</p> <ol><li>设置索引时可能会修改length，设置length时可能会影响数组元素</li></ol></li> <li><p>遍历数组</p> <ul><li>for...in和遍历对象时相同，使用<strong>length</strong>属性作为追踪的key</li> <li>for...of遍历可迭代对象的，数组内建了Symbol.iterator方法的实现</li></ul></li> <li><p>数组的查找方法,incodes/indexOf/lastIndexOf，通过apply实现的,将this指向代理对象。<strong>实现了对原始对象和代理对象的查找</strong>。</p></li> <li><p>栈方法通过设置是否追踪，实现对track的屏蔽</p></li></ol> <h4 id="代理set和map-有空了再看"><a href="#代理set和map-有空了再看" class="header-anchor">#</a> 代理Set和Map(有空了再看)</h4> <h3 id="原始值的响应式方案"><a href="#原始值的响应式方案" class="header-anchor">#</a> 原始值的响应式方案</h3> <ol><li>使用一个非原始值<strong>包裹</strong>原始值，</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 封装一个ref函数</span>
fuction <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 内部创建一个包裹对象</span>
	<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">value</span><span class="token operator">:</span>val
	<span class="token punctuation">}</span>
    <span class="token comment">// 将包裹对象变成响应式数据</span>
	<span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>区分包裹对象和非原始值的响应式对象</p> <ol start="2"><li><strong>响应丢失</strong>问题：...展开运算符，将响应式数据转换成类似于ref结构的数据</li> <li><strong>自动脱ref</strong>：<strong>去掉.value</strong>,通过Proxy代理实现，如果访问的属性是ref，直接返回它的value</li></ol> <h2 id="渲染器renderer"><a href="#渲染器renderer" class="header-anchor">#</a> 渲染器renderer</h2> <h3 id="渲染器的设计"><a href="#渲染器的设计" class="header-anchor">#</a> 渲染器的设计</h3> <p>利用响应系统，自动调用渲染器，实现页面的渲染和更新。</p> <p>渲染器吧虚拟DOM节点渲染成真实DOM节点的过程叫做<strong>挂载</strong>。</p> <p><strong>自定义渲染器</strong>，将依赖于浏览器的API进行抽离。这样可以在NodeJs中执行。</p> <h3 id="挂载与更新"><a href="#挂载与更新" class="header-anchor">#</a> 挂载与更新</h3> <ol><li><p>挂载子节点和元素的属性，setAttribute</p></li> <li><p>HTML attributes作用是DOM properties的<strong>初始值</strong></p></li> <li><p>正确地设置<strong>元素属性</strong>：优先使用DOM properties，封装为一个<strong>pathProps</strong>函数</p></li> <li><p><strong>class</strong>的特殊处理，结构转换，<strong>el.className</strong>/el.classList/setAttribute性能更好</p></li> <li><p>卸载操作：渲染null空内容时发生</p> <p>innerHTML清空的缺点：</p> <ul><li>不能正确的调用子组件的生命周期钩子函数</li> <li>不会触发自定义指令的钩子函数</li> <li>不会移除DOM元素上的事件处理函数</li></ul></li></ol> <p>​	<strong>让vnode.el引用真实的DOM元素</strong>，并封装为unmount函数</p> <ol start="6"><li>区分vnode的类型</li> <li><strong>事件</strong>的处理：约定以on开头的属性是事件；伪造一个事件处理函数<strong>invoker</strong>，把它的值指向具体的事件，避免更新事件时移除上一个事件，单一事件可以有多个处理函数，使用<strong>数组</strong></li> <li>事件的冒泡和更新时机，需要屏蔽所有绑定时间<strong>晚于</strong>事件触发时间的事件处理函数的执行</li> <li><strong>更新子节点</strong>，子节点的类型有三种：文本/空/其他，将逻辑封装为<strong>patchChildren</strong>，理清判断逻辑，总共有9种情况</li> <li>文本节点和注释节点</li> <li>Fragment 本身不会渲染任何DOM元素，只需要渲染Fragment的所有子节点</li></ol> <h3 id="简单diff算法-从头到尾"><a href="#简单diff算法-从头到尾" class="header-anchor">#</a> 简单diff算法(从头到尾)</h3> <ol><li>减少DOM操作的性能开销，<strong>遍历较短的一组</strong>，如果新的长，说明需要挂载，旧的长，说明需要卸载</li> <li>DOM的复用和Key的作用，引入额外的<strong>key</strong>作为vnode的标识，key相同进行patch</li> <li>找到需要移动的元素</li> <li><strong>如何移动元素</strong>，遍历新的子节点，根据在旧子节点中的引用，移动真实DOM，记录最大索引，<strong>核心是移动到前一个对应的真实DOM后面</strong>，</li> <li>添加新元素，在旧的中找不到时find=false</li> <li>移除不存在的元素。在新的中遍历完旧的之后，需要<strong>反过来遍历一次</strong>，查找需要删除的元素。</li></ol> <h3 id="双端diff算法-从头尾到中间"><a href="#双端diff算法-从头尾到中间" class="header-anchor">#</a> 双端diff算法(从头尾到中间)</h3> <p>同时对新旧子节点的两个端点进行扫描，需要<strong>四个索引值</strong></p> <p>每一轮步骤：以新的数组为移动依据</p> <ul><li>比较旧的起始与新的起始，如果key匹配，patch后,newstart++，oldstart++</li> <li>比较旧的结束语新的结束，如果key匹配，patch后,newend--,oldend--</li> <li><strong>比较旧的开始与新的结束</strong>，如果key匹配，patch后，<strong>oldstart的真实DOM移动到oldend真实DOM之后</strong>，,newstart++，oldend--</li> <li><strong>比较旧的结束与新的开始</strong>，如果key匹配，patch后，<strong>oldend的真实DOM移动到oldstart真实DOM之前</strong>，,oldstart++，newend--</li></ul> <p>​	每一轮移动两个指针,直至新旧两组指针相遇</p> <p>非理想情况：</p> <ul><li>找到newstart在old中的索引，并移动到最前面，old中的原来的位置变为undefined</li> <li>old中遇到undefined，跳过</li></ul> <p>添加新元素：diff完之后，再遍历一次new节点，每次都插在oldstart之前</p> <p>移除不存在的元素：遍历old，依次卸载剩余的。</p> <h3 id="快速diff算法"><a href="#快速diff算法" class="header-anchor">#</a> 快速diff算法</h3> <p>类似于文本diff，先对前缀，后缀进行预处理</p> <p>预处理流程：</p> <ul><li>判断前缀，指针j</li> <li>判断后缀，newend，oldend</li></ul> <p>非理想情况：预处理结束后，new、old都有剩余，用<strong>source</strong>记录new的剩余，source存储new中的节点在old中的索引。建立<strong>索引表</strong>，时间复杂度降为O(n)</p> <ul><li>在source中寻找最长递增子序列(可以不连续)，从后向前遍历source[i]及其最长递增子序列seq[s]。
<ul><li>source[i]==-1，则挂载该节点</li> <li>i!=seq[s]，需要移动节点</li></ul></li></ul> <p><strong>最长递增子序列</strong>中的节点位置是不需要移动的</p> <h2 id="组件化"><a href="#组件化" class="header-anchor">#</a> 组件化</h2> <h3 id="组件的实现原理"><a href="#组件的实现原理" class="header-anchor">#</a> 组件的实现原理</h3> <ol><li><p>渲染组件用<strong>vnode.type存储组件对象</strong></p></li> <li><p>组件状态与自更新</p> <ul><li>执行data()函数，并用reactive()包装为响应式对象</li> <li>调用render函数，this指向state</li> <li>将渲染任务包装在effect中</li> <li>通过调度器，将任务缓冲到<strong>微任务队列</strong>中，这样就有机会对任务进行去重</li></ul></li> <li><p>组件实例与组件的生命周期</p> <p>组件实例是一个<strong>状态合集</strong>，维护者组件运行过程中的所有信息</p> <ul><li>state：组件自身状态数据</li> <li>isMounted：表示是否被挂载</li> <li>subTree：渲染函数返回的虚拟DOM</li></ul></li> <li><p>props与组件的被动更新</p> <ul><li>将MyComponent.props和vnode.props结合，解析出props和attrs，其中attrs是MyComponent中没有定义的props</li> <li><strong>被动更新</strong>就是父组件更新引起的子组件更新</li> <li>封装一个渲染上下文对象<strong>renderContext</strong>，并优先从上下文中读取，实质上是<strong>组件实例的代理对象</strong></li></ul></li> <li><p>setup函数的作用与实现（只会在被挂载时执行一次）</p> <ul><li>配合组合式API，建立组合逻辑、创建响应式数据、创建函数、注册生命周期钩子等等</li> <li>接受两个参数<strong>props，setupContext</strong>,后者存储着slots、emit、attrs、expose</li> <li>如果返回<strong>数据对象</strong>，则需要暴露在渲染上下文中。</li></ul></li> <li><p>注册事件和emit的实现</p> <p>通过v-on指令为组件绑定的事件，经过编译后，会以<strong>OnXXX</strong>形式存储在props属性中。</p> <p>触发自定义事件的本质就是，根据事件名称去<strong>props数据对象</strong>中寻找相应的事件处理函数并执行。</p></li> <li><p>插槽的工作原理和实现</p> <p>组件模板的插槽内容会被编译为插槽函数，插槽函数执行的返回值就是具体的插槽内容</p></li> <li><p>注册生命周期</p> <p>维护一个当前组件实例currentInstance和mount数组</p></li></ol> <h3 id="异步组件与函数式组件"><a href="#异步组件与函数式组件" class="header-anchor">#</a> 异步组件与函数式组件</h3> <h4 id="异步组件的实现原理"><a href="#异步组件的实现原理" class="header-anchor">#</a> 异步组件的实现原理</h4> <ul><li>封装defineAsyncComponent函数，判断是否加载成功</li> <li>加载器、超时时间、并可以指定出错是渲染的模块。把错误对象传递到Error组件中</li> <li>loading组件，delay后加载loading</li> <li>重试机制，为用户提供重试的能力</li></ul> <h4 id="函数式组件"><a href="#函数式组件" class="header-anchor">#</a> 函数式组件</h4> <p>函数式组件本质就是一个普通函数，返回值是一个虚拟DOM</p> <h3 id="内建组件和模块"><a href="#内建组件和模块" class="header-anchor">#</a> 内建组件和模块</h3> <h4 id="keepalive组件"><a href="#keepalive组件" class="header-anchor">#</a> KeepAlive组件</h4> <p><strong>本质是缓存管理，加上特殊的挂载、卸载逻辑。</strong></p> <p>在内部组件的vnode对象上添加一些属性，以便渲染器能够据此执行特定的逻辑。</p> <ul><li>shouldKeepAlive：渲染之卸载内部组件时可以判断是否需要被keepalive</li> <li>keepAliveInstance：便于卸载时访问失活函数</li> <li>KeptAlive：标记已经被缓存</li></ul> <p>include与exclude</p> <p>缓存管理：Map</p> <ul><li>map的键是组件选项对象，vnode.type，值是vnode对象，虚拟DOM</li> <li>设置缓存的阈值，超出时修剪，策略<strong>最新一次访问</strong></li></ul> <h4 id="teleport组件"><a href="#teleport组件" class="header-anchor">#</a> Teleport组件</h4> <p><strong>将执行内容渲染到特定容器中，不受DOM层级的限制。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Teleportt <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">__isTeleport</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span>n2<span class="token punctuation">,</span>container<span class="token punctuation">,</span>anchor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 渲染逻辑</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="transition组件"><a href="#transition组件" class="header-anchor">#</a> Transition组件</h4> <p>帮助制作基于状态变化的过渡和动画</p> <p>核心原理：</p> <ul><li>当DOM元素被挂载时，将动效附加在该DOM上</li> <li>当DOM元素被卸载时，不立即卸载，而是等到附加在DOM上的动效执行完成后在卸载</li></ul> <h2 id="编译器"><a href="#编译器" class="header-anchor">#</a> 编译器</h2> <h3 id="编译器核心技术概览-3步"><a href="#编译器核心技术概览-3步" class="header-anchor">#</a> 编译器核心技术概览(3步)</h3> <p>完整的编译：词法分析、语法分析、语义分析、中间代码生成、优化、目标代码生成</p> <p>vue的编译是DSL，将vue编译为渲染函数</p> <p>vue的编译：模板、词法分析、语法分析、<strong>模板AST、Transformer、JS AST</strong>、代码生成、渲染函数</p> <p>模板AST：</p> <ul><li>type区分不同节点</li> <li>标签节点的子节点在children中</li> <li>属性和指令在props数组</li> <li>不同节点的对象属性不同</li></ul> <p>语义分析：</p> <ul><li>检查v-else是否存在对应的v-if</li> <li>分析属性值是否是静态的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> templateAST <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
<span class="token keyword">const</span> jsAST <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>templateAST<span class="token punctuation">)</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>jsAST<span class="token punctuation">)</span>
</code></pre></div><h4 id="parser的实现原理与状态机"><a href="#parser的实现原理与状态机" class="header-anchor">#</a> parser的实现原理与状态机</h4> <p>解析器逐个读取字符串模板的字符，根据一定规则，切割成一个个<strong>token</strong></p> <p><strong>有限状态自动机</strong>，随着字符的输入，解析器会在不同状态间迁移，将模板解析为一个一个的token</p> <h4 id="构造模板ast"><a href="#构造模板ast" class="header-anchor">#</a> 构造模板AST</h4> <p>递归下降算法，</p> <p>栈+token列表可以实现</p> <h4 id="ast的转换"><a href="#ast的转换" class="header-anchor">#</a> AST的转换</h4> <ul><li>深度优先遍历</li> <li>对节点的操作和访问解耦，存放在<strong>上下文context</strong>中
<ul><li>currentNode： 当前正转换的节点</li> <li>childIndex：当前节点在父节点的children中的位置索引</li> <li>parent：用来存储当前转换的父节点</li></ul></li> <li>元素的进入与退出</li></ul> <h4 id="生成js-ast"><a href="#生成js-ast" class="header-anchor">#</a> 生成JS AST</h4> <p>函数声明语句：</p> <ul><li>id 函数名称</li> <li>params：函数的参数</li> <li>body:函数体</li></ul> <h3 id="解析器"><a href="#解析器" class="header-anchor">#</a> 解析器</h3> <h3 id="编译优化"><a href="#编译优化" class="header-anchor">#</a> 编译优化</h3> <h2 id="服务端渲染"><a href="#服务端渲染" class="header-anchor">#</a> 服务端渲染</h2> <h3 id="同构渲染"><a href="#同构渲染" class="header-anchor">#</a> 同构渲染</h3></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/23/2024, 8:55:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-end/Vue/" class="prev router-link-active">
        ♥Vue技术体系♥
      </a></span> <span class="next"><a href="/front-end/Vue/Vue面试.html">
        什么是MVVM、MVC？
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a000d84e.js" defer></script><script src="/assets/js/2.994b757b.js" defer></script><script src="/assets/js/50.d3186f56.js" defer></script>
  </body>
</html>
